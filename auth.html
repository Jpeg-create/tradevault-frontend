<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TradeVault - Sign In</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="auth-page">
  <div class="auth-box">

    <div class="auth-header">
      <div class="auth-logo"><div class="auth-logo-icon"><svg width="44" height="44" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="vgl" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#00d4ff"/><stop offset="100%" stop-color="#a3e635"/></linearGradient></defs><circle cx="24" cy="24" r="21" stroke="url(#vgl)" stroke-width="2.5" fill="rgba(0,212,255,0.05)"/><circle cx="24" cy="24" r="15" stroke="url(#vgl)" stroke-width="1.5" fill="rgba(0,212,255,0.04)"/><line x1="3" y1="24" x2="9" y2="24" stroke="url(#vgl)" stroke-width="2.5" stroke-linecap="round"/><circle cx="24" cy="7" r="2" fill="url(#vgl)"/><circle cx="24" cy="41" r="2" fill="url(#vgl)"/><circle cx="7" cy="24" r="2" fill="url(#vgl)"/><circle cx="41" cy="24" r="2" fill="url(#vgl)"/><rect x="13" y="28" width="3" height="6" rx="0.5" fill="#00d4ff"/><line x1="14.5" y1="26" x2="14.5" y2="28" stroke="#00d4ff" stroke-width="1.2"/><rect x="19" y="21" width="3" height="10" rx="0.5" fill="#a3e635"/><line x1="20.5" y1="18" x2="20.5" y2="21" stroke="#a3e635" stroke-width="1.2"/><rect x="25" y="24" width="3" height="8" rx="0.5" fill="#00d4ff"/><line x1="26.5" y1="21" x2="26.5" y2="24" stroke="#00d4ff" stroke-width="1.2"/><rect x="31" y="17" width="3" height="13" rx="0.5" fill="#a3e635"/><line x1="32.5" y1="14" x2="32.5" y2="17" stroke="#a3e635" stroke-width="1.2"/><polyline points="13,29 19,22 25,25 32,15" stroke="#a3e635" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></div><div class="auth-logo-text">Trade<span>Vault</span></div></div>
      <div class="auth-tagline">Your professional trading journal</div>
    </div>

    <div id="wake-banner-slot"></div>

    <div class="auth-tabs" id="auth-tabs">
      <button class="auth-tab active" id="tab-login"  onclick="switchTab('login')">Login</button>
      <button class="auth-tab"        id="tab-signup" onclick="switchTab('signup')">Sign Up</button>
    </div>

    <div class="auth-alert error"   id="auth-error"></div>
    <div class="auth-alert success" id="auth-success"></div>

    <!-- ── LOGIN ─────────────────────────────────────────── -->
    <div id="form-login" class="auth-form active">
      <div class="form-group">
        <label class="form-label" for="login-email">Email</label>
        <input type="email" class="form-input" id="login-email" name="email"
          autocomplete="email" placeholder="you@email.com">
      </div>
      <div class="form-group">
        <div class="form-label-row">
          <label class="form-label" for="login-password">Password</label>
          <button type="button" class="auth-link" onclick="switchTab('forgot')">Forgot password?</button>
        </div>
        <input type="password" class="form-input" id="login-password" name="password"
          autocomplete="current-password" placeholder="Your password">
      </div>
      <button class="btn btn-primary btn-block" id="login-btn" onclick="handleLogin()">Login</button>
    </div>

    <!-- ── SIGN UP ────────────────────────────────────────── -->
    <div id="form-signup" class="auth-form">
      <div class="form-group">
        <label class="form-label" for="signup-name">Full Name</label>
        <input type="text" class="form-input" id="signup-name" name="name"
          autocomplete="name" placeholder="Your name">
      </div>
      <div class="form-group">
        <label class="form-label" for="signup-email">Email</label>
        <input type="email" class="form-input" id="signup-email" name="email"
          autocomplete="email" placeholder="you@email.com">
      </div>
      <div class="form-group">
        <label class="form-label" for="signup-password">Password</label>
        <input type="password" class="form-input" id="signup-password"
          autocomplete="new-password" placeholder="Min 6 characters"
          oninput="checkPasswordStrength(this.value)">
        <div class="password-strength" id="pw-strength">
          <div class="pw-bar"><div class="pw-fill" id="pw-fill"></div></div>
          <span class="pw-label" id="pw-label"></span>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="signup-confirm">Confirm Password</label>
        <input type="password" class="form-input" id="signup-confirm"
          autocomplete="new-password" placeholder="Repeat your password">
      </div>
      <button class="btn btn-primary btn-block" id="signup-btn" onclick="handleSignup()">Create Account</button>
    </div>

    <!-- ── FORGOT PASSWORD ────────────────────────────────── -->
    <div id="form-forgot" class="auth-form">
      <div class="auth-back">
        <button class="auth-link" onclick="switchTab('login')">← Back to Login</button>
      </div>
      <p class="auth-hint">Enter your email and we'll send you a reset link.</p>
      <div class="form-group">
        <label class="form-label" for="forgot-email">Email</label>
        <input type="email" class="form-input" id="forgot-email"
          autocomplete="email" placeholder="you@email.com">
      </div>
      <button class="btn btn-primary btn-block" id="forgot-btn" onclick="handleForgot()">Send Reset Link</button>
    </div>

    <!-- ── RESET PASSWORD ──────────────────────────────────── -->
    <div id="form-reset" class="auth-form">
      <div class="auth-back">
        <button class="auth-link" onclick="switchTab('login')">← Back to Login</button>
      </div>
      <p class="auth-hint">Enter your reset token and choose a new password.</p>
      <div class="form-group">
        <label class="form-label" for="reset-token">Reset Token</label>
        <input type="text" class="form-input" id="reset-token"
          placeholder="Paste your reset token here" autocomplete="off">
      </div>
      <div class="form-group">
        <label class="form-label" for="reset-password">New Password</label>
        <input type="password" class="form-input" id="reset-password"
          autocomplete="new-password" placeholder="Min 6 characters">
      </div>
      <div class="form-group">
        <label class="form-label" for="reset-confirm">Confirm New Password</label>
        <input type="password" class="form-input" id="reset-confirm"
          autocomplete="new-password" placeholder="Repeat new password">
      </div>
      <button class="btn btn-primary btn-block" id="reset-btn" onclick="handleReset()">Set New Password</button>
    </div>

    <!-- ── GOOGLE ──────────────────────────────────────────── -->
    <div id="google-section">
      <div class="auth-divider"><span>or</span></div>
      <button class="google-btn" onclick="handleGoogleLogin()">
        <svg class="google-icon" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continue with Google
      </button>
    </div>

  </div><!-- /.auth-box -->

  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
  <script>
    // ── BOOT ───────────────────────────────────────────────
    if (getToken()) window.location.href = '/app';

    // Check for reset token in URL (?reset=TOKEN)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('reset')) {
      document.getElementById('reset-token').value = urlParams.get('reset');
      switchTab('reset');
    }

    // Pre-warm Render server (free tier sleeps after 15 min)
    (async () => {
      const slot = document.getElementById('wake-banner-slot');
      const banner = document.createElement('div');
      banner.className = 'wake-banner';
      banner.textContent = '⏳ Server waking up — may take up to 30 seconds on first load…';
      slot.appendChild(banner);
      try {
        await api.ping();
        banner.remove();
      } catch {
        banner.textContent = '⚠️ Could not reach server. Check connection or try again.';
      }
    })();

    // ── HELPERS ────────────────────────────────────────────
    function switchTab(tab) {
      ['login','signup','forgot','reset'].forEach(f => {
        document.getElementById('form-' + f).classList.toggle('active', f === tab);
      });
      const showTabs = tab === 'login' || tab === 'signup';
      document.getElementById('auth-tabs').style.display      = showTabs ? 'flex'  : 'none';
      document.getElementById('google-section').style.display = showTabs ? 'block' : 'none';
      document.getElementById('tab-login').classList.toggle('active',  tab === 'login');
      document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
      showError(''); showSuccess('');
    }

    function showError(msg) {
      const el = document.getElementById('auth-error');
      el.textContent = msg;
      el.classList.toggle('show', !!msg);
    }

    function showSuccess(msg) {
      const el = document.getElementById('auth-success');
      el.innerHTML = '';
      if (msg) { el.textContent = msg; el.classList.add('show'); }
      else      { el.classList.remove('show'); }
    }

    function setBtnLoading(id, loading, label) {
      const btn = document.getElementById(id);
      btn.disabled = loading;
      btn.innerHTML = loading
        ? '<span class="spinner"></span> Please wait…'
        : label;
    }

    function checkPasswordStrength(val) {
      const wrap  = document.getElementById('pw-strength');
      const fill  = document.getElementById('pw-fill');
      const label = document.getElementById('pw-label');
      if (!val) { wrap.style.display = 'none'; return; }
      wrap.style.display = 'flex';
      let score = 0;
      if (val.length >= 6)          score++;
      if (val.length >= 10)         score++;
      if (/[A-Z]/.test(val))        score++;
      if (/[0-9]/.test(val))        score++;
      if (/[^A-Za-z0-9]/.test(val)) score++;
      const levels = [
        { pct:'20%', color:'var(--accent-red)',    text:'Weak' },
        { pct:'40%', color:'#ff8c32',              text:'Fair' },
        { pct:'60%', color:'var(--accent-yellow)', text:'Medium' },
        { pct:'80%', color:'#a8e063',              text:'Good' },
        { pct:'100%',color:'var(--accent-green)',  text:'Strong' },
      ];
      const lvl = levels[Math.min(score - 1, 4)] || levels[0];
      fill.style.width      = lvl.pct;
      fill.style.background = lvl.color;
      label.textContent     = lvl.text;
      label.style.color     = lvl.color;
    }

    // ── LOGIN ──────────────────────────────────────────────
    async function handleLogin() {
      const email    = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if (!email || !password) return showError('Please fill in both fields');
      setBtnLoading('login-btn', true, 'Login');
      try {
        const res = await api.login({ email, password });
        saveAuth(res.token, res.user);
        window.location.href = '/app';
      } catch (err) {
        showError(err.message);
        setBtnLoading('login-btn', false, 'Login');
      }
    }

    // ── SIGN UP ────────────────────────────────────────────
    async function handleSignup() {
      const name     = document.getElementById('signup-name').value.trim();
      const email    = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      const confirm  = document.getElementById('signup-confirm').value;
      if (!name || !email || !password) return showError('Please fill in all fields');
      if (password.length < 6)          return showError('Password must be at least 6 characters');
      if (password !== confirm)          return showError('Passwords do not match');
      setBtnLoading('signup-btn', true, 'Create Account');
      try {
        const res = await api.signup({ name, email, password });
        saveAuth(res.token, res.user);
        window.location.href = '/app';
      } catch (err) {
        showError(err.message);
        setBtnLoading('signup-btn', false, 'Create Account');
      }
    }

    // ── FORGOT PASSWORD ────────────────────────────────────
    async function handleForgot() {
      const email = document.getElementById('forgot-email').value.trim();
      if (!email) return showError('Please enter your email');
      setBtnLoading('forgot-btn', true, 'Send Reset Link');
      try {
        const res = await api.resetPasswordRequest({ email });

        if (res.devToken) {
          // No email service yet — show token on screen
          const successEl = document.getElementById('auth-success');
          successEl.innerHTML = '';
          successEl.classList.add('show');

          const msg = document.createElement('div');
          msg.textContent = 'No email service configured. Click the token to copy it, then use it below:';
          msg.style.marginBottom = '0.75rem';
          successEl.appendChild(msg);

          const tokenBox = document.createElement('div');
          tokenBox.style.cssText = 'background:var(--bg-primary);border:1px solid var(--border-color);border-radius:2px;padding:.75rem;font-size:.72rem;word-break:break-all;color:var(--accent-green);cursor:pointer;font-family:monospace;';
          tokenBox.textContent = res.devToken;
          tokenBox.title = 'Click to copy';
          tokenBox.onclick = () => {
            navigator.clipboard.writeText(res.devToken).then(() => {
              tokenBox.style.borderColor = 'var(--accent-green)';
              tokenBox.textContent = '✓ Copied!';
              setTimeout(() => {
                document.getElementById('reset-token').value = res.devToken;
                switchTab('reset');
              }, 800);
            });
          };
          successEl.appendChild(tokenBox);

          const link = document.createElement('button');
          link.className = 'auth-link';
          link.style.cssText = 'display:block;margin-top:.75rem;';
          link.textContent = '→ Go to Reset Password form';
          link.onclick = () => {
            document.getElementById('reset-token').value = res.devToken;
            switchTab('reset');
          };
          successEl.appendChild(link);
        } else {
          showSuccess(res.message || 'Reset email sent! Check your inbox and spam folder.');
        }

        setBtnLoading('forgot-btn', false, 'Send Reset Link');
      } catch (err) {
        showError(err.message);
        setBtnLoading('forgot-btn', false, 'Send Reset Link');
      }
    }

    // ── RESET PASSWORD ─────────────────────────────────────
    async function handleReset() {
      const token       = document.getElementById('reset-token').value.trim();
      const newPassword = document.getElementById('reset-password').value;
      const confirm     = document.getElementById('reset-confirm').value;
      if (!token)                        return showError('Please paste your reset token');
      if (!newPassword || newPassword.length < 6) return showError('Password must be at least 6 characters');
      if (newPassword !== confirm)        return showError('Passwords do not match');
      setBtnLoading('reset-btn', true, 'Set New Password');
      try {
        await api.resetPassword({ token, newPassword });
        showSuccess('Password updated! Redirecting to login…');
        setTimeout(() => switchTab('login'), 2000);
      } catch (err) {
        showError(err.message);
      } finally {
        setBtnLoading('reset-btn', false, 'Set New Password');
      }
    }

    // ── GOOGLE ─────────────────────────────────────────────
    function handleGoogleLogin() {
      if (!CONFIG.GOOGLE_CLIENT_ID || CONFIG.GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
        showError('Google login is not configured yet. Please use email and password.');
        return;
      }
      google.accounts.id.initialize({
        client_id: CONFIG.GOOGLE_CLIENT_ID,
        callback: async (response) => {
          try {
            const res = await api.googleLogin({ credential: response.credential });
            saveAuth(res.token, res.user);
            window.location.href = '/app';
          } catch (err) { showError(err.message); }
        }
      });
      google.accounts.id.prompt();
    }

    // ── ENTER KEY SUPPORT ──────────────────────────────────
    document.addEventListener('keydown', e => {
      if (e.key !== 'Enter') return;
      const active = ['login','signup','forgot','reset'].find(t =>
        document.getElementById('form-' + t).classList.contains('active')
      );
      if (active === 'login')  handleLogin();
      if (active === 'signup') handleSignup();
      if (active === 'forgot') handleForgot();
      if (active === 'reset')  handleReset();
    });
  </script>
</body>
</html>
