<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TradeVault - Sign In</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="auth-page">
  <div class="auth-box">
    <div class="auth-logo">TradeVault</div>
    <div class="auth-tagline">Your professional trading journal</div>

    <!-- TABS — hidden on reset screens -->
    <div class="auth-tabs" id="auth-tabs">
      <div class="auth-tab active" id="tab-login"  onclick="switchTab('login')">Login</div>
      <div class="auth-tab"        id="tab-signup" onclick="switchTab('signup')">Sign Up</div>
    </div>

    <div class="auth-error" id="auth-error"></div>
    <div class="auth-success" id="auth-success"></div>

    <!-- ── LOGIN ───────────────────────────────────────── -->
    <div id="form-login">
      <div class="form-group">
        <label class="form-label" for="login-email">Email</label>
        <input type="email" class="form-input" id="login-email" name="email"
          autocomplete="email" placeholder="you@email.com">
      </div>
      <div class="form-group">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.45rem">
          <label class="form-label" for="login-password" style="margin-bottom:0">Password</label>
          <button class="auth-link" onclick="switchTab('forgot')">Forgot password?</button>
        </div>
        <input type="password" class="form-input" id="login-password" name="password"
          autocomplete="current-password" placeholder="Your password">
      </div>
      <button class="btn btn-primary" style="width:100%" id="login-btn" onclick="handleLogin()">
        Login
      </button>
    </div>

    <!-- ── SIGN UP ──────────────────────────────────────── -->
    <div id="form-signup" style="display:none">
      <div class="form-group">
        <label class="form-label" for="signup-name">Full Name</label>
        <input type="text" class="form-input" id="signup-name" name="name"
          autocomplete="name" placeholder="Your name">
      </div>
      <div class="form-group">
        <label class="form-label" for="signup-email">Email</label>
        <input type="email" class="form-input" id="signup-email" name="email"
          autocomplete="email" placeholder="you@email.com">
      </div>
      <div class="form-group">
        <label class="form-label" for="signup-password">Password</label>
        <input type="password" class="form-input" id="signup-password" name="new-password"
          autocomplete="new-password" placeholder="Min 6 characters"
          oninput="checkPasswordStrength(this.value)">
        <div class="password-strength" id="pw-strength" style="display:none">
          <div class="pw-bar"><div class="pw-fill" id="pw-fill"></div></div>
          <span class="pw-label" id="pw-label"></span>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="signup-confirm">Confirm Password</label>
        <input type="password" class="form-input" id="signup-confirm"
          autocomplete="new-password" placeholder="Repeat your password">
      </div>
      <button class="btn btn-primary" style="width:100%" id="signup-btn" onclick="handleSignup()">
        Create Account
      </button>
    </div>

    <!-- ── FORGOT PASSWORD ──────────────────────────────── -->
    <div id="form-forgot" style="display:none">
      <div class="auth-back">
        <button class="auth-link" onclick="switchTab('login')">← Back to Login</button>
      </div>
      <p class="auth-hint">Enter your email and we'll send you a reset link.</p>
      <div class="form-group">
        <label class="form-label" for="forgot-email">Email</label>
        <input type="email" class="form-input" id="forgot-email"
          autocomplete="email" placeholder="you@email.com">
      </div>
      <button class="btn btn-primary" style="width:100%" id="forgot-btn" onclick="handleForgot()">
        Send Reset Link
      </button>
    </div>

    <!-- ── RESET PASSWORD ───────────────────────────────── -->
    <div id="form-reset" style="display:none">
      <div class="auth-back">
        <button class="auth-link" onclick="switchTab('login')">← Back to Login</button>
      </div>
      <p class="auth-hint">Enter the reset token from your email and your new password.</p>
      <div class="form-group">
        <label class="form-label" for="reset-token">Reset Token</label>
        <input type="text" class="form-input" id="reset-token"
          placeholder="Paste your reset token here" autocomplete="off">
      </div>
      <div class="form-group">
        <label class="form-label" for="reset-password">New Password</label>
        <input type="password" class="form-input" id="reset-password"
          autocomplete="new-password" placeholder="Min 6 characters">
      </div>
      <div class="form-group">
        <label class="form-label" for="reset-confirm">Confirm New Password</label>
        <input type="password" class="form-input" id="reset-confirm"
          autocomplete="new-password" placeholder="Repeat new password">
      </div>
      <button class="btn btn-primary" style="width:100%" id="reset-btn" onclick="handleReset()">
        Set New Password
      </button>
    </div>

    <!-- ── GOOGLE ────────────────────────────────────────── -->
    <div id="google-section">
      <div class="auth-divider">or</div>
      <button class="google-btn" onclick="handleGoogleLogin()">
        <svg class="google-icon" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continue with Google
      </button>
    </div>
  </div>

  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
  <script>
    if (getToken()) window.location.href = '/index.html';

    // Pre-warm the Render server (free tier sleeps after 15min inactivity)
    // This fires immediately on page load so the server is ready when user submits
    let serverReady = false;
    (async () => {
      const banner = document.createElement('div');
      banner.id = 'wake-banner';
      banner.style.cssText = 'background:rgba(255,217,61,.1);border:1px solid rgba(255,217,61,.3);color:#ffd93d;padding:.6rem 1rem;border-radius:8px;font-size:.78rem;margin-bottom:1rem;text-align:center;';
      banner.textContent = '⏳ Server is waking up — this may take 30 seconds on first load…';
      document.querySelector('.auth-box').insertBefore(banner, document.querySelector('.auth-tabs'));
      try {
        await api.ping();
        serverReady = true;
        banner.remove();
      } catch {
        banner.textContent = '⚠️ Could not reach server. Check your connection or try again shortly.';
      }
    })();

    // Check if arriving from a reset link with token in URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('reset')) {
      document.getElementById('reset-token').value = urlParams.get('reset');
      switchTab('reset');
    }

    function switchTab(tab) {
      const forms = ['login','signup','forgot','reset'];
      forms.forEach(f => {
        document.getElementById('form-' + f).style.display = f === tab ? 'block' : 'none';
      });
      // Show/hide tabs
      const showTabs = tab === 'login' || tab === 'signup';
      document.getElementById('auth-tabs').style.display = showTabs ? 'flex' : 'none';
      document.getElementById('google-section').style.display = showTabs ? 'block' : 'none';
      // Update active tab
      document.getElementById('tab-login').classList.toggle('active',  tab === 'login');
      document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
      showError(''); showSuccess('');
    }

    function showError(msg) {
      const el = document.getElementById('auth-error');
      el.textContent = msg; el.classList.toggle('show', !!msg);
    }
    function showSuccess(msg) {
      const el = document.getElementById('auth-success');
      el.textContent = msg; el.classList.toggle('show', !!msg);
    }

    function setBtnLoading(id, loading, label) {
      const btn = document.getElementById(id);
      btn.disabled = loading;
      btn.innerHTML = loading ? '<span class="spinner"></span> Please wait…' : label;
    }

    function checkPasswordStrength(val) {
      const el = document.getElementById('pw-strength');
      const fill = document.getElementById('pw-fill');
      const label = document.getElementById('pw-label');
      if (!val) { el.style.display = 'none'; return; }
      el.style.display = 'flex';
      let score = 0;
      if (val.length >= 6)  score++;
      if (val.length >= 10) score++;
      if (/[A-Z]/.test(val)) score++;
      if (/[0-9]/.test(val)) score++;
      if (/[^A-Za-z0-9]/.test(val)) score++;
      const levels = [
        { pct:'20%', color:'var(--accent-red)',    text:'Very weak' },
        { pct:'40%', color:'#ff8c32',              text:'Weak' },
        { pct:'60%', color:'var(--accent-yellow)', text:'Fair' },
        { pct:'80%', color:'#a8e063',              text:'Good' },
        { pct:'100%',color:'var(--accent-green)',  text:'Strong' },
      ];
      const lvl = levels[Math.min(score - 1, 4)] || levels[0];
      fill.style.width = lvl.pct;
      fill.style.background = lvl.color;
      label.textContent = lvl.text;
      label.style.color = lvl.color;
    }

    async function handleLogin() {
      const email    = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if (!email || !password) return showError('Please fill in both fields');
      setBtnLoading('login-btn', true, 'Login');
      try {
        const res = await api.login({ email, password });
        saveAuth(res.token, res.user);
        window.location.href = '/index.html';
      } catch (err) {
        showError(err.message);
        setBtnLoading('login-btn', false, 'Login');
      }
    }

    async function handleSignup() {
      const name     = document.getElementById('signup-name').value.trim();
      const email    = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      const confirm  = document.getElementById('signup-confirm').value;
      if (!name || !email || !password) return showError('Please fill in all fields');
      if (password.length < 6) return showError('Password must be at least 6 characters');
      if (password !== confirm) return showError('Passwords do not match');
      setBtnLoading('signup-btn', true, 'Create Account');
      try {
        const res = await api.signup({ name, email, password });
        saveAuth(res.token, res.user);
        window.location.href = '/index.html';
      } catch (err) {
        showError(err.message);
        setBtnLoading('signup-btn', false, 'Create Account');
      }
    }

    async function handleForgot() {
      const email = document.getElementById('forgot-email').value.trim();
      if (!email) return showError('Please enter your email');
      setBtnLoading('forgot-btn', true, 'Send Reset Link');
      try {
        const res = await api.resetPasswordRequest({ email });

        if (res.devToken) {
          // No email service configured — show token directly
          showSuccess('No email service set up yet. Use the token below to reset your password:');
          const tokenBox = document.createElement('div');
          tokenBox.style.cssText = 'background:#0a0e14;border:1px solid #2a3140;border-radius:8px;padding:.875rem;margin-top:.75rem;font-size:.78rem;word-break:break-all;color:#00ff88;font-family:monospace;cursor:pointer;';
          tokenBox.textContent = res.devToken;
          tokenBox.title = 'Click to copy';
          tokenBox.onclick = () => {
            navigator.clipboard.writeText(res.devToken).then(() => {
              tokenBox.style.borderColor = '#00ff88';
              tokenBox.textContent = '✓ Copied! Now click "Enter reset token" below.';
            });
          };
          document.getElementById('auth-success').appendChild(tokenBox);
          // Pre-fill the reset form
          document.getElementById('reset-token').value = res.devToken;
          // Show a link to switch to reset form
          const link = document.createElement('button');
          link.className = 'auth-link';
          link.style.cssText = 'display:block;margin-top:.75rem;font-size:.82rem;';
          link.textContent = '→ Enter reset token';
          link.onclick = () => switchTab('reset');
          document.getElementById('auth-success').appendChild(link);
        } else {
          showSuccess(res.message || 'Reset email sent! Check your inbox and spam folder.');
        }
        setBtnLoading('forgot-btn', false, 'Send Reset Link');
      } catch (err) {
        showError(err.message);
        setBtnLoading('forgot-btn', false, 'Send Reset Link');
      }
    }

    async function handleReset() {
      const token       = document.getElementById('reset-token').value.trim();
      const newPassword = document.getElementById('reset-password').value;
      const confirm     = document.getElementById('reset-confirm').value;
      if (!token) return showError('Please enter your reset token');
      if (!newPassword || newPassword.length < 6) return showError('Password must be at least 6 characters');
      if (newPassword !== confirm) return showError('Passwords do not match');
      setBtnLoading('reset-btn', true, 'Set New Password');
      try {
        await api.resetPassword({ token, newPassword });
        showSuccess('Password updated! You can now log in.');
        setTimeout(() => switchTab('login'), 2000);
      } catch (err) {
        showError(err.message);
        setBtnLoading('reset-btn', false, 'Set New Password');
      }
    }

    function handleGoogleLogin() {
      if (!CONFIG.GOOGLE_CLIENT_ID || CONFIG.GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
        showError('Google login is not set up yet. Please use email and password.');
        return;
      }
      google.accounts.id.initialize({
        client_id: CONFIG.GOOGLE_CLIENT_ID,
        callback: async (response) => {
          try {
            const res = await api.googleLogin({ credential: response.credential });
            saveAuth(res.token, res.user);
            window.location.href = '/index.html';
          } catch (err) { showError(err.message); }
        }
      });
      google.accounts.id.prompt();
    }

    document.addEventListener('keydown', e => {
      if (e.key !== 'Enter') return;
      const active = ['login','signup','forgot','reset'].find(t =>
        document.getElementById('form-' + t).style.display !== 'none'
      );
      if (active === 'login')  handleLogin();
      if (active === 'signup') handleSignup();
      if (active === 'forgot') handleForgot();
      if (active === 'reset')  handleReset();
    });
  </script>
</body>
</html>
