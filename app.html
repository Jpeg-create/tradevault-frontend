<!DOCTYPE html>
<html lang="en">
<head>
  <script>try{var t=localStorage.getItem("q_theme")||"dark";document.documentElement.setAttribute("data-theme",t);}catch(e){}</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Quantario - Trading Journal</title>

  <!-- â”€â”€ PWA â”€â”€ -->
  <link rel="manifest" href="/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Quantario">
  <link rel="apple-touch-icon" href="/icons/icon-180.png">
  <meta name="theme-color" content="#FF6535" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#FFFCFB" media="(prefers-color-scheme: light)">
  <meta name="description" content="Your professional trading journal. Track trades, spot patterns, improve your performance.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">

  <script>
    // Apply saved theme before paint
    (function(){
      const t = localStorage.getItem('q_theme') || 'dark';
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>
</head>
<body>
  <div id="toast-container"></div>
  <div id="app"></div>

  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
  <script>
    // Guard â€” redirect to login if not authenticated
    if (!getToken()) window.location.href = '/login';
  </script>
  <script src="/js/app.js"></script>

  <!-- â”€â”€ PWA: Service Worker + Install Prompt â”€â”€ -->
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch((err) => {
          console.warn('[SW] Registration failed:', err);
        });
      });
    }

    // Handle app shortcut action (?action=add-trade)
    window.addEventListener('load', () => {
      const params = new URLSearchParams(location.search);
      if (params.get('action') === 'add-trade') {
        // Wait for app to initialise then open modal
        setTimeout(() => {
          if (typeof openAddTradeModal === 'function') openAddTradeModal();
        }, 800);
      }
    });

    // â”€â”€ Install prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      _deferredPrompt = e;

      // Only show if not already installed and not dismissed before
      const dismissed = localStorage.getItem('q_pwa_dismissed');
      if (dismissed) return;

      // Wait for app to load, then show the banner
      setTimeout(showPWABanner, 3000);
    });

    window.addEventListener('appinstalled', () => {
      _deferredPrompt = null;
      document.getElementById('pwa-banner')?.remove();
      localStorage.setItem('q_pwa_installed', '1');
    });

    function showPWABanner() {
      if (document.getElementById('pwa-banner')) return;
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches
        || window.navigator.standalone;
      if (isStandalone) return; // already installed

      const banner = document.createElement('div');
      banner.id = 'pwa-banner';
      banner.className = 'pwa-banner';
      banner.innerHTML = `
        <div class="pwa-banner-icon">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
            <defs><linearGradient id="pwa-g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#FF6535"/><stop offset="100%" stop-color="#FF2D6B"/>
            </linearGradient></defs>
            <circle cx="16" cy="16" r="14" stroke="url(#pwa-g)" stroke-width="2.5" fill="rgba(255,101,53,0.08)"/>
            <circle cx="16" cy="16" r="2.2" fill="url(#pwa-g)"/>
            <circle cx="16" cy="4.5" r="1.8" fill="url(#pwa-g)"/>
            <circle cx="16" cy="27.5" r="1.8" fill="url(#pwa-g)"/>
            <circle cx="4.5" cy="16" r="1.8" fill="url(#pwa-g)"/>
            <circle cx="27.5" cy="16" r="1.8" fill="url(#pwa-g)"/>
          </svg>
        </div>
        <div class="pwa-banner-text">
          <div class="pwa-banner-title">Add Quantario to your home screen</div>
          <div class="pwa-banner-sub">Faster access Â· Works offline Â· No app store needed</div>
        </div>
        <div class="pwa-banner-actions">
          <button class="btn btn-primary btn-sm pwa-install-btn" onclick="triggerPWAInstall()">Install</button>
          <button class="pwa-dismiss-btn" onclick="dismissPWABanner()" title="Dismiss">âœ•</button>
        </div>
      `;
      document.body.appendChild(banner);
      requestAnimationFrame(() => banner.classList.add('show'));
    }

    function triggerPWAInstall() {
      if (!_deferredPrompt) return;
      _deferredPrompt.prompt();
      _deferredPrompt.userChoice.then((choice) => {
        if (choice.outcome === 'accepted') {
          document.getElementById('pwa-banner')?.remove();
        }
        _deferredPrompt = null;
      });
    }

    function dismissPWABanner() {
      const banner = document.getElementById('pwa-banner');
      if (banner) {
        banner.classList.remove('show');
        setTimeout(() => banner.remove(), 300);
      }
      localStorage.setItem('q_pwa_dismissed', '1');
    }

    // iOS Safari: show manual install instructions
    const isIOS = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
    const isStandalone = window.navigator.standalone;
    if (isIOS && !isStandalone && !localStorage.getItem('q_pwa_dismissed')) {
      setTimeout(() => {
        if (document.getElementById('pwa-banner')) return;
        const banner = document.createElement('div');
        banner.id = 'pwa-banner';
        banner.className = 'pwa-banner';
        banner.innerHTML = `
          <div class="pwa-banner-icon">ðŸ“²</div>
          <div class="pwa-banner-text">
            <div class="pwa-banner-title">Add to Home Screen</div>
            <div class="pwa-banner-sub">Tap <strong>Share</strong> â†’ <strong>Add to Home Screen</strong> for app-like experience</div>
          </div>
          <div class="pwa-banner-actions">
            <button class="pwa-dismiss-btn" onclick="dismissPWABanner()" title="Dismiss">âœ•</button>
          </div>`;
        document.body.appendChild(banner);
        requestAnimationFrame(() => banner.classList.add('show'));
      }, 4000);
    }
  </script>
</body>
</html>
